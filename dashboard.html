<!--dashboard.html--> 
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>SMU Gym Super App Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <header>
    <img src="https://www.smu.edu.sg/sites/default/files/smu-logo.jpg" alt="SMU Logo">
    <h2>Singapore Management University</h2>
    <button class="auth-btn" id="logout-btn-header">Logout</button>
  </header>

  <section class="hero">
    <h1>Gym User Dashboard</h1>
  </section>

  <div class="layout-flex">
    <!-- Sidebar -->
    <ul class="menu-list sidebar">
      <li><a id="nav-dashboard" class="active" href="#">Dashboard</a></li>
      <li><a id="nav-workout" href="#">Workout Log</a></li>
      <li><a id="nav-food" href="#">Food Orders</a></li>
      <li><a id="nav-trainer" href="#">Personal Trainer</a></li>
    </ul>
    <div class="main-content">
      <!-- Dashboard Overview -->
      <div id="dashboard-section">
        <div class="dashboard-card">
          <h3>Welcome, <span id="user-name">User</span>!</h3>
          <p>
            Your personalized fitness dashboard is ready.<br>
            Use the navigation on the left to log workouts, order food, or book a trainer.
          </p>
        </div>
        <div class="dashboard-overview-flex">
          <div id="dashboard-latest-workout" class="dashboard-card"></div>
          <div id="dashboard-latest-food" class="dashboard-card"></div>
          <div id="dashboard-trainer-bookings" class="dashboard-card"></div>
        </div>
      </div>
      <!-- Workout Tab -->
      <div id="workout-section" style="display:none;">
        <h3>Workout Log</h3>
        <div class="dashboard-card">
          <p>Log your workouts here.</p>
        </div>
        <div id="workout-ui-root"></div>
      </div>
      <!-- Food Tab -->
      <div id="food-section" style="display:none;">
        <h3>Food Orders</h3>
        <div class="dashboard-card">
          <p>Order your post-workout meals here.</p>
        </div>
        <div id="food-order-section"></div>
        <div id="food-order-history"></div>
      </div>
      <!-- Trainer Tab -->
      <div id="trainer-section" style="display:none;">
        <h3>Personal Trainer</h3>
        <div class="dashboard-card">
          <p>Book your personal trainer session here.</p>
        </div>
        <form id="trainer-booking-form"></form>
        <div id="trainer-booking-message"></div>
        <div id="trainer-bookings-history"></div>
      </div>
    </div>
  </div>

  <footer>
    &copy; 2025 Singapore Management University. All Rights Reserved.
  </footer>

  <!-- Firebase config/module scripts -->
  <script type="module" src="firebase-config.js"></script>
  <script type="module" src="auth.js"></script>
  <script src="spa-nav.js"></script>
  <!-- <script type="module" src="app.js"></script> -->
  <script type="module" src="food-order.js"></script>
  <script type="module" src="trainer.js"></script>
  <script type="module" src="workout.js"></script>

  <script type="module">
    import { db, auth } from "./firebase-config.js";
    import {
      collection, query, where, orderBy, getDocs
    } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

    // LATEST WORKOUT SUMMARY
    async function loadDashboardLatestWorkout() {
      const user = auth.currentUser;
      const dashDiv = document.getElementById('dashboard-latest-workout');
      if (!user || !dashDiv) return;
      console.log("DASHBOARD: user", user.uid, dashDiv);

      const q = query(
        collection(db, "workout_sessions"),
        where("userId", "==", user.uid),
        orderBy("timestamp", "desc")
      );
      const snap = await getDocs(q);
      console.log("DASHBOARD: snap.size", snap.size);
      let html = '<strong>Latest Workout</strong><br>';
      if (snap.size > 0) {
        const d = snap.docs[0].data();
        console.log("DASHBOARD: session data", d);
        html += `<div>
<span style="color:#888;font-size:1em;">${new Date(d.timestamp.seconds * 1000).toLocaleString()}</span><br>`;
        d.session.forEach(se => {
          html += `<b>${se.exercise}</b> `;
          html += se.sets.map(s => `<span class="set-badge">${s.weight}kg x ${s.reps}</span>`).join(' ');
          html += `<br>`;
        });
        html += `</div>`;
      } else {
        html += "<span style='color:#888;'>No workouts logged yet.</span>";
      }
      dashDiv.innerHTML = html;
    }
    window.loadDashboardLatestWorkout = loadDashboardLatestWorkout;

    // LATEST FOOD SUMMARY
    async function loadDashboardLatestFoodOrder() {
      const user = auth.currentUser;
      const dashDiv = document.getElementById('dashboard-latest-food');
      if (!user || !dashDiv) return;

      const q = query(
        collection(db, "food_orders"),
        where("userId", "==", user.uid),
        orderBy("date", "desc")
      );
      const snap = await getDocs(q);

      let html = '<strong>Latest Food Order</strong><br>';
      if (snap.size > 0) {
        const d = snap.docs[0].data();
        html += `
          <div>
            <strong style="color:#004aad">${d.meal}</strong> &bull; ${d.gym}<br>
            <span>Collection: ${d.date}</span><br>
            <span style="color:#888;font-size:0.97em;">${d.desc}</span>
          </div>
        `;
      } else {
        html += "<span style='color:#888;'>No food orders yet.</span>";
      }
      dashDiv.innerHTML = html;
    }
    window.loadDashboardLatestFoodOrder = loadDashboardLatestFoodOrder;

    // TRAINER BOOKINGS SUMMARY
    async function loadDashboardTrainerBookings() {
      const user = auth.currentUser;
      const dashDiv = document.getElementById('dashboard-trainer-bookings');
      if (!user || !dashDiv) return;

      // Query all of this user's bookings, sorted earliest to latest
      const q = query(
        collection(db, "trainer_bookings"),
        where("userId", "==", user.uid),
        orderBy("date", "asc"),    // earliest first
        orderBy("time", "asc")
      );
      const snap = await getDocs(q);

      let html = '<strong>Trainer Booking</strong>';
      const now = new Date();

      // Find first booking that is in the future
      let found = false;
      snap.forEach(doc => {
        const d = doc.data();

        // Combine date+time into JS Date
        // (Assumes 'date' is YYYY-MM-DD and 'time' is HH:mm)
        const bookingDateTime = new Date(`${d.date}T${d.time}`);
        // If booking is in the future
        if (!found && bookingDateTime > now) {
          html += `<div style="background:#f5f9ff; border-radius:12px; margin:15px 0; padding:12px 18px;">
        <strong style="color:#004aad;">${d.trainer}</strong><br>
        <small>${d.date} at ${d.time}</small>
      </div>`;
          found = true;
        }
      });

      if (!found) {
        html += "<br/><span style='color:#888;'>No upcoming bookings.</span>";
      }
      dashDiv.innerHTML = html;
    }
    window.loadDashboardTrainerBookings = loadDashboardTrainerBookings;

    // Ensure dashboard summaries update after auth loads
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
    onAuthStateChanged(auth, user => {
      if (user) {
        loadDashboardLatestWorkout();
        loadDashboardLatestFoodOrder();
        loadDashboardTrainerBookings();
      }
    });
  </script>
</body>

</html>